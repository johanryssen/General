- Create a ROOTLESS CONTAINER that
- starts automatically with 
- systemd with 
- mapped ports and 
- persistent storage


To run podman as rootless:

# Prerequisites

(1) Enable cgroups v2
(2) To allow rootless operation of Podman containers:
- Determine which user(s) and group(s) you want to use for the containers
- Add their corresponding entries to /etc/subuid and /etc/subgid respectively.

----------

(1) Enable cgroups v2

# Enable This Kernel Paramater

$ echo 'kernel.unprivileged_userns_clone=1' > /etc/sysctl.d/userns.conf

# Edit grub

# Use one of them:
- systemd.unified_cgroup_hierarchy=1	# Systemd will mount /sys/fs/cgroup as cgroup v2
- cgroup_no_v1="all"					# The kernel will disable all v1 cgroup controllers

---
$ sudo vim /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT=".... systemd.unified_cgroup_hierarchy=1 --or-- cgroup_no_v1="all""
---

# Manual Method
$ mount -t cgroup2 none /sys/fs/cgroup

# To Check
# For V2
$ ls /sys/fs/cgroup

cgroup.controllers      cgroup.subtree_control  init.scope/      system.slice/
cgroup.max.depth        cgroup.threads          io.cost.model    user.slice/
cgroup.max.descendants  cpu.pressure            io.cost.qos
cgroup.procs            cpuset.cpus.effective   io.pressure
cgroup.stat             cpuset.mems.effective   memory.pressure

# V1 ( if you see these file then your cgroup is on v1 )
$ ls /sys/fs/cgroup

blkio/    cpu,cpuacct/  freezer/  net_cls@           perf_event/  systemd/
cpu@      cpuset/       hugetlb/  net_cls,net_prio/  pids/        unified/
cpuacct@  devices/      memory/   net_prio@          rdma/

# Update
$ sudo grub-mkconfig -o /boot/grub/grub.cfg
$ reboot

-----
lsns - list namespaces
-----

## 2.0 Enable UIDs and GIDs for User

# The following below commands enables the podman user and group to run containers.
# It allocates the UIDs and GIDs from 100000to 165535 to the podman user and group respectively.

$ sudo touch /etc/{subgid,subuid}
$ sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 {USER}
$ grep {USER} /etc/subuid /etc/subgid
/etc/subuid:{USER}:100000:65536
/etc/subgid:{USER}:100000:65536

====================================================================


--- Image & Containers Location ---
Podman ( root ): /var/lib/containers/storage/
Podman ( normal_user ): ~/.local/share/containers/storage
Docker: /var/lib/docker
-----------------------------------


$ mkdir ~/mongodir
$ podman run -d -p 27017:27017 -v ~/mongodir:/data/db:Z --name myContainer01 docker.io/library/mongo:latest
$ podman run -d -p 27017:27017 -v ~/mongodir:/data/db:Z --name con_$(date +%s) docker.io/library/mongo:latest

The Z option tells Podman to label the content with a PRIVATE UNSHARED LABEL.


# podman-run - Run a command in a new container
podman run -d -p 8000:80 -v ~/alpine:/var/www/html:Z --name alpine01 docker.io/library/alpine:latest
podman run -t -i -v /etc/:/testdir --rm fedora sh -c 'ls -l /testdir 2> /dev/null | head -n 10'

------------------------

When podman runs in rootless mode, a user namespace is automatically created for the user, defined in /etc/subuid and /etc/subgid.

Containers created by a non-root user are not visible to other users and are not seen or managed by Podman running as root.

It is required to have multiple uids/gids set for an user.
Be sure the user is present in the files /etc/subuid and /etc/subgid.

If you have a recent version of usermod, you can execute the following commands to add the ranges to the files

$ sudo usermod --add-subuids 10000-75535 USERNAME
$ sudo usermod --add-subgids 10000-75535 USERNAME

Or just add the content manually.

$ echo USERNAME:10000:65536 >> /etc/subuid
$ echo USERNAME:10000:65536 >> /etc/subgid

See the subuid(5) and subgid(5) man pages for more information.

Images are pulled under XDG_DATA_HOME when specified, otherwise in the home directory of the user under .local/share/containers/storage.

Currently the slirp4netns package is required to be installed to create a network device, otherwise rootless containers need to run in the network namespace of the host.

