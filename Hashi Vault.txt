
https://learn.acloud.guru/course/hashicorp-vault/overview

--- SETUP ---

choco install vault

# PowerShell:
$env:VAULT_ADDR="http://127.0.0.1:8200"

# cmd.exe:
set VAULT_ADDR=http://127.0.0.1:8200

Unseal Key: 0FpSbh7IVyfO5kNh1NNhIuGCp6fqX/yCntq2+ZfdRUY=
Root Token: s.DpDLpspbCpo5SoQwctljSC4j

$env:VAULT_TOKEN="s.XmpNPoi9sRhYtdKHaQhkHP6x"


----------------------------------------------------


--- Docker ---

# Start Vault in development mode:
docker run --rm --cap-add=IPC_LOCK -e VAULT_ADDR=http://localhost:8200 -p 8200:8200 -d --name=dev-vault vault:1.6.0

# Check that vault is running with:
docker logs dev-vault

# In development mode, Vault gets configured with several options that makes it convenient:
- Vault is already initialized with one key share (whereas in normal mode this has to be done explicitly and the number of key shares is 5 by default)
- the unseal key and the root token are displayed in the logs (please write down the root token, we will need it in the following step)
- Vault is unsealed
- in-memory storage
- TLS is disabled
- a kv secret engine v2 is mounted at secret/

# open a shell inside the vault container:
docker exec -it dev-vault sh

# Set the VAULT_TOKEN with the value that was printed in the log:
export VAULT_TOKEN=s.5VUS8pte13RqekCB2fmMT3u2

# Check Vaultâ€™s status using the CLI command
vault status

# Add a secret configuration for the app:
vault kv put secret/myapps/vault-quickstart/config a-private-key=123456

# We have defined a path secret/myapps/vault-quickstart in Vault that we need to give access to from the Quarkus application.

# Create a policy that gives read access to secret/myapps/vault-quickstart and subpaths:
cat <<EOF | vault policy write vault-quickstart-policy -
path "secret/data/myapps/vault-quickstart/*" {
  capabilities = ["read"]
}
EOF

--- NOTE ---
When using a kv secret engine version 2, secrets are written and fetched at path:
<mount>/data/<secret-path>

as opposed to:
<mount>/<secret-path>
in a kv secret engine version 1.

It does not change any of the CLI commands (i.e. you do not specify data in your path).
However it DOES CHANGE THE POLICIES, since capabilities are applied to the real path.
In the example above, the path is secret/data/myapps/vault-quickstart/* since we are working with a kv secret engine version 2.
It would be secret/myapps/vault-quickstart/* with a kv secret engine version 1.
------------

# Enable the userpass auth secret engine, and create user bob with access to the vault-quickstart-policy:
vault auth enable userpass
vault write auth/userpass/users/bob password=sinclair policies=vault-quickstart-policy

# Check that the configuration is correct, try logging in:
vault login -method=userpass username=bob password=sinclair

## You should see:
Success! You are now authenticated...

# Set VAULT_TOKEN to the token above (instead of the root token), and try reading the vault-quickstart secret config:
export VAULT_TOKEN=s.s93BVzJPzBiIGuYJHBTkG8Uw
vault kv get secret/myapps/vault-quickstart/config

## You should see:
======== Data ========
Key              Value
---              -----
a-private-key    123456


----------------------------------------------------

# Trigger a Vault configuration reload (ExecReload):
/bin/kill --signal HUP $MAINPID


--- SYSTEMD ---

[Unit]
Description="HashiCorp Vault - A tool for managing secrets"
Documentation=https://www.vaultproject.io/docs/
Requires=network-online.target
After=network-online.target ConditionFileNotEmpty=/etc/vault.d/vault.hcl
StartLimitIntervalSec=60
StartLimitBurst=3

[Service]
User=vault
Group=vault
ProtectSystem=full
ProtectHome=read-only
PrivateTmp=yes
PrivateDevices=yes
SecureBits=keep-caps
AmbientCapabilities=CAP_IPC_LOCK
Capabilities=CAP_IPC_LOCK+ep
CapabilityBoundingSet=CAP_SYSLOG CAP_IPC_LOCK
NoNewPrivileges=yes
ExecStart=/usr/local/bin/vault server -config=/etc/vault.d/vault.hcl
ExecReload=/bin/kill --signal HUP $MAINPID 
KillMode=process 
KillSignal=SIGINT 
Restart=on-failure 
RestartSec=5
TimeoutStopSec=30
StartLimitInterval=60
StartLimitIntervalSec=60
StartLimitBurst=3
LimitNOFILE=65536
LimitMEMLOCK=infinity

[Install]
WantedBy=multi-user.target


----------------------------------------------------


